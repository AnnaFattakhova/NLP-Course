# -*- coding: utf-8 -*-
"""bot.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1OegX6y6iyfINt6NKhKdqy7WmtDqZ2Xwl
"""

!pip install aiogram -q

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏

from aiogram import Bot, Dispatcher, types  # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º
import logging  # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
import asyncio  # –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –∫–æ–¥–æ–º
import nest_asyncio
import sys  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏
import json
import numpy as np

from aiogram.types import Message
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.filters import Command
from aiogram.types.message import ContentType

import gensim
from gensim.models import Word2Vec

from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity

"""**–ö–æ–¥ —á–∞—Å—Ç—è–º–∏**"""

# –¢–æ–∫–µ–Ω API –±–æ—Ç–∞

API_TOKEN = "token"

## –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏
logging.basicConfig(level=logging.INFO)
# –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Ö–æ–¥—è—â–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –∏ –∫–æ–º–∞–Ω–¥–∞–º–∏
dp = Dispatcher()

# –î–µ–∫–æ—Ä–∞—Ç–æ—Ä @dp.message() —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
@dp.message()
async def echo(message: types.Message):
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–∫–æ—Ä—É—Ç–∏–Ω–∞), –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    –û–Ω–∞ –ø–æ–ª—É—á–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç.

    :param message: –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    await message.answer("–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –±–æ—Ç.")  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

async def main():
    """
    –û—Å–Ω–æ–≤–Ω–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞.
    1. –°–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç –±–æ—Ç–∞ —Å API —Ç–æ–∫–µ–Ω–æ–º.
    2. –ó–∞–ø—É—Å–∫–∞–µ—Ç –¥–∏—Å–ø–µ—Ç—á–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—á–∏–Ω–∞–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.
    """
    bot = Bot(token=API_TOKEN)
    await dp.start_polling(bot)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–∞–ø—Ä—è–º—É—é (–Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª)
if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    await main()

## –ó–∞–≥—Ä—É–∂–∞–µ–º json —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –æ—Ç–≤–µ—Ç–∞–º–∏

!wget data.json https://raw.githubusercontent.com/vifirsanova/compling/refs/heads/main/tasks/task3/faq.json -O data.json


with open("data.json", "r") as file:
    data = json.load(file)  # data - —ç—Ç–æ —Å–ª–æ–≤–∞—Ä—å –∏–∑ JSON-—Ñ–∞–π–ª–∞


# –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö
faq_questions = []
faq_answers = []
for i in data.values():
    for y in i:
        faq_questions.append(y['question'])
        faq_answers.append(y['answer'])

#print(faq_questions)
#print(faq_answers)

## –í–∞—Ä–∏–∞–Ω—Ç —Å –≤—ã–≤–æ–¥–æ–º –¥–≤—É—Ö –æ—Ç–≤–µ—Ç–æ–≤ (–Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–≤—É—Ö –º–µ—Ç–æ–¥–æ–≤)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–∞
bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ TF-IDF
vectorizer = TfidfVectorizer()
tfidf_matrix = vectorizer.fit_transform(faq_questions)

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Word2Vec
sentences = [q.split() for q in faq_questions]
model = Word2Vec(sentences, vector_size=100, window=5, min_count=1, workers=4)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è –≤–µ–∫—Ç–æ—Ä–æ–≤ —Å–ª–æ–≤ –≤ –≤–æ–ø—Ä–æ—Å–µ
def sentence_vector(sentence, model):
    words = sentence.split()
    vectors = [model.wv[word] for word in words if word in model.wv]

    if not vectors:
        return np.zeros(model.vector_size)

    return np.mean(vectors, axis=0)

# –í–µ–∫—Ç–æ—Ä–∏–∑—É–µ–º –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è Word2Vec
faq_vectors = np.array([sentence_vector(q, model) for q in faq_questions])

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ TF-IDF
def get_answer_tfidf(query):
    query_vec = vectorizer.transform([query])
    similarities_tfidf = cosine_similarity(query_vec, tfidf_matrix)
    best_match_idx_tfidf = similarities_tfidf.argmax()
    return faq_answers[best_match_idx_tfidf]

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ Word2Vec
def get_answer_word2vec(query):
    query_vector = sentence_vector(query, model).reshape(1, -1)
    similarities_w2v = cosine_similarity(query_vector, faq_vectors)
    best_match_idx_w2v = similarities_w2v.argmax()
    return faq_answers[best_match_idx_w2v]

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
@dp.message()
async def answer_question(message: types.Message):
    question = message.text
    answer_tfidf = get_answer_tfidf(question)
    answer_word2vec = get_answer_word2vec(question)
    await message.answer("–û—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ TF-IDF: " + answer_tfidf)
    await message.answer("–û—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ Word2Vec: " + answer_word2vec)


# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    await main()

## –í–∞—Ä–∏–∞–Ω—Ç —Å –≤—ã–≤–æ–¥–æ–º –æ–¥–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±–æ—Ä–∞ –ª—É—á—à–µ–≥–æ - —Å –±–æ–ª—å—à–µ–π —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–π –±–ª–∏–∑–æ—Å—Ç—å—é)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–∞
bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ TF-IDF
vectorizer = TfidfVectorizer()
tfidf_matrix = vectorizer.fit_transform(faq_questions)

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Word2Vec
sentences = [q.split() for q in faq_questions]
model = Word2Vec(sentences, vector_size=100, window=5, min_count=1, workers=4)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è –≤–µ–∫—Ç–æ—Ä–æ–≤ —Å–ª–æ–≤ –≤ –≤–æ–ø—Ä–æ—Å–µ
def sentence_vector(sentence, model):
    words = sentence.split()
    vectors = [model.wv[word] for word in words if word in model.wv]

    if not vectors:
        return np.zeros(model.vector_size)

    return np.mean(vectors, axis=0)

# –í–µ–∫—Ç–æ—Ä–∏–∑—É–µ–º –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è Word2Vec
faq_vectors = np.array([sentence_vector(q, model) for q in faq_questions])

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ TF-IDF
def get_answer_tfidf(query):
    query_vec = vectorizer.transform([query])
    similarities_tfidf = cosine_similarity(query_vec, tfidf_matrix)
    best_match_idx_tfidf = similarities_tfidf.argmax()
    return faq_answers[best_match_idx_tfidf], similarities_tfidf.max()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ Word2Vec
def get_answer_word2vec(query):
    query_vector = sentence_vector(query, model).reshape(1, -1)
    similarities_w2v = cosine_similarity(query_vector, faq_vectors)
    best_match_idx_w2v = similarities_w2v.argmax()
    return faq_answers[best_match_idx_w2v], similarities_w2v.max()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞–∏–ª—É—á—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏–∑ TF-IDF –∏ Word2Vec
def get_best_answer(query):
    answer_tfidf, similarity_tfidf = get_answer_tfidf(query)
    answer_word2vec, similarity_w2v = get_answer_word2vec(query)

    # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å—Ö–æ–∂–µ—Å—Ç–∏ –∏ –≤—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–π –æ—Ç–≤–µ—Ç
    if similarity_tfidf > similarity_w2v:
        return answer_tfidf
    else:
        return answer_word2vec

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
@dp.message()
async def answer_question(message: types.Message):
    question = message.text
    best_answer = get_best_answer(question)  # –í—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–π –æ—Ç–≤–µ—Ç
    await message.answer(best_answer)

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    await main()

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫

bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# –°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
kb = [
    [
        KeyboardButton(text="–û –∫–æ–º–ø–∞–Ω–∏–∏"), # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–ø–∞–Ω–∏–∏
        KeyboardButton(text="–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è")  # –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ –±—ã –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è
    ]
]

# –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –∫–Ω–æ–ø–∫–∞–º–∏
keyboard = ReplyKeyboardMarkup(
    keyboard=kb, # –ü–µ—Ä–µ–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫
    resize_keyboard=True, # –£–º–µ–Ω—å—à–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
    input_field_placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ" # –¢–µ–∫—Å—Ç-–ø–æ–¥—Å–∫–∞–∑–∫–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    )

@dp.message(Command("start"))
async def start_command(message: types.Message):
    await message.answer("–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –æ —Ä–∞–±–æ—Ç–µ –∫–æ–º–ø–∞–Ω–∏–∏. –° —á–µ–º –≤–∞–º –ø–æ–º–æ—á—å?", reply_markup=keyboard) # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –≤ –∫–æ–º–∞–Ω–¥—É start

# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–û –±–æ—Ç–µ"
@dp.message(lambda message: message.text == "–û –∫–æ–º–ø–∞–Ω–∏–∏") # –§–∏–ª—å—Ç—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ç–µ–∫—Å—Ç–æ–º "–û –∫–æ–º–ø–∞–Ω–∏–∏"
async def about_bot(message: types.Message):
    """
    –§—É–Ω–∫—Ü–∏—è –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –æ–Ω –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "–û –±–æ—Ç–µ".
    """
    await message.answer("‚û° –ù–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –¥–æ—Å—Ç–∞–≤–∫–æ–π —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–µ.")

# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è": –±–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–∞ –≤—Ö–æ–¥ –∫–∞—Ä—Ç–∏–Ω–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∫—Ä–∏–Ω—à–æ—Ç) –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ—ë –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞, –∞ —Ç–∞–∫–∂–µ —Ç–µ–∫—Å—Ç "–í–∞—à –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É"
@dp.message(lambda message: message.text == "–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è")
async def complain(message: types.Message):
    await message.answer("üìé –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –∂–∞–ª–æ–±–æ–π.")

# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
@dp.message(lambda message: message.photo)
async def handle_photo(message: types.Message):
    photo = message.photo[-1]  # –ë–µ—Ä—ë–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º
    file_info = await message.bot.get_file(photo.file_id)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–æ—Ç–æ
    response = f"‚úÖ –í–∞—à–µ —Ñ–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ!\n\nüìå –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞: {file_info.file_path}\nüîé –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ~{photo.file_size} –±–∞–π—Ç\n\nüì≤ –í–∞—à –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É."
    await message.answer(response)

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())

"""**–ö–û–î –¶–ï–õ–ò–ö–û–ú (–≤–∞—Ä–∏–∞–Ω—Ç —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ–¥–Ω–æ–≥–æ –ª—É—á—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞)**"""

!pip install aiogram -q

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏

from aiogram import Bot, Dispatcher, types  # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º
import logging  # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
import asyncio  # –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –∫–æ–¥–æ–º
import nest_asyncio
import sys  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏
import json
import numpy as np

from aiogram.types import Message
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.filters import Command
from aiogram.types.message import ContentType

import gensim
from gensim.models import Word2Vec

from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity

# –¢–æ–∫–µ–Ω API –±–æ—Ç–∞
API_TOKEN = "token"

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
!wget data.json https://raw.githubusercontent.com/vifirsanova/compling/refs/heads/main/tasks/task3/faq.json -O data.json
with open("data.json", "r") as file:
    data = json.load(file)  # data - —ç—Ç–æ —Å–ª–æ–≤–∞—Ä—å –∏–∑ JSON-—Ñ–∞–π–ª–∞


# –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö
faq_questions = []
faq_answers = []
for i in data.values():
    for y in i:
        faq_questions.append(y['question'])
        faq_answers.append(y['answer'])


# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–∞
bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ TF-IDF
vectorizer = TfidfVectorizer()
tfidf_matrix = vectorizer.fit_transform(faq_questions)

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Word2Vec
sentences = [q.split() for q in faq_questions]
model = Word2Vec(sentences, vector_size=100, window=5, min_count=1, workers=4)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è –≤–µ–∫—Ç–æ—Ä–æ–≤ —Å–ª–æ–≤ –≤ –≤–æ–ø—Ä–æ—Å–µ
def sentence_vector(sentence, model):
    words = sentence.split()
    vectors = [model.wv[word] for word in words if word in model.wv]

    if not vectors:
        return np.zeros(model.vector_size)

    return np.mean(vectors, axis=0)

# –í–µ–∫—Ç–æ—Ä–∏–∑—É–µ–º –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è Word2Vec
faq_vectors = np.array([sentence_vector(q, model) for q in faq_questions])

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ TF-IDF
def get_answer_tfidf(query):
    query_vec = vectorizer.transform([query])
    similarities_tfidf = cosine_similarity(query_vec, tfidf_matrix)
    best_match_idx_tfidf = similarities_tfidf.argmax()
    return faq_answers[best_match_idx_tfidf], similarities_tfidf.max()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ Word2Vec
def get_answer_word2vec(query):
    query_vector = sentence_vector(query, model).reshape(1, -1)
    similarities_w2v = cosine_similarity(query_vector, faq_vectors)
    best_match_idx_w2v = similarities_w2v.argmax()
    return faq_answers[best_match_idx_w2v], similarities_w2v.max()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞–∏–ª—É—á—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏–∑ TF-IDF –∏ Word2Vec
def get_best_answer(query):
    answer_tfidf, similarity_tfidf = get_answer_tfidf(query)
    answer_word2vec, similarity_w2v = get_answer_word2vec(query)

    # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å—Ö–æ–∂–µ—Å—Ç–∏ –∏ –≤—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–π –æ—Ç–≤–µ—Ç
    if similarity_tfidf > similarity_w2v:
        return answer_tfidf
    else:
        return answer_word2vec

# –°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
kb = [
    [
        KeyboardButton(text="–û –∫–æ–º–ø–∞–Ω–∏–∏"), # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–ø–∞–Ω–∏–∏
        KeyboardButton(text="–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è")  # –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ –±—ã –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è
    ]
]

# –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –∫–Ω–æ–ø–∫–∞–º–∏
keyboard = ReplyKeyboardMarkup(
    keyboard=kb, # –ü–µ—Ä–µ–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫
    resize_keyboard=True, # –£–º–µ–Ω—å—à–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
    input_field_placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ" # –¢–µ–∫—Å—Ç-–ø–æ–¥—Å–∫–∞–∑–∫–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    )

@dp.message(Command("start"))
async def start_command(message: types.Message):
    await message.answer("–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –æ —Ä–∞–±–æ—Ç–µ –∫–æ–º–ø–∞–Ω–∏–∏. –° —á–µ–º –≤–∞–º –ø–æ–º–æ—á—å?", reply_markup=keyboard) # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –≤ –∫–æ–º–∞–Ω–¥—É start

# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–û –±–æ—Ç–µ"
@dp.message(lambda message: message.text == "–û –∫–æ–º–ø–∞–Ω–∏–∏") # –§–∏–ª—å—Ç—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ç–µ–∫—Å—Ç–æ–º "–û –∫–æ–º–ø–∞–Ω–∏–∏"
async def about_bot(message: types.Message):
    """
    –§—É–Ω–∫—Ü–∏—è –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –æ–Ω –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "–û –±–æ—Ç–µ".
    """
    await message.answer("‚û° –ù–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –¥–æ—Å—Ç–∞–≤–∫–æ–π —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–µ.")

# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è": –±–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–∞ –≤—Ö–æ–¥ –∫–∞—Ä—Ç–∏–Ω–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∫—Ä–∏–Ω—à–æ—Ç) –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ—ë –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞, –∞ —Ç–∞–∫–∂–µ —Ç–µ–∫—Å—Ç "–í–∞—à –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É"
@dp.message(lambda message: message.text == "–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è")
async def complain(message: types.Message):
    await message.answer("üìé –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –∂–∞–ª–æ–±–æ–π.")

# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
@dp.message(lambda message: message.photo)
async def handle_photo(message: types.Message):
    photo = message.photo[-1]  # –ë–µ—Ä—ë–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º
    file_info = await message.bot.get_file(photo.file_id)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–æ—Ç–æ
    response = f"‚úÖ –í–∞—à–µ —Ñ–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ!\n\nüìå –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞: {file_info.file_path}\nüîé –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ~{photo.file_size} –±–∞–π—Ç\n\nüì≤ –í–∞—à –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É."
    await message.answer(response)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
@dp.message()
async def answer_question(message: types.Message):
    question = message.text
    best_answer = get_best_answer(question)  # –í—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–π –æ—Ç–≤–µ—Ç
    await message.answer(best_answer)

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    await main()